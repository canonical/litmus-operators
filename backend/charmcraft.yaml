# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
name: litmus-backend-k8s
type: charm
title: Litmus Backend Server

assumes:
  - k8s-api
  - juju >= 3.6.0

description: |
  Litmus Backend Server is a component of the LitmusChaos solution, an open source platform used for chaos testing.
  It is responsible for serving APIs for the ChaosCenter.

summary: |
  Litmus Backend Server is a component of the LitmusChaos solution, an open source platform used for chaos testing.

containers:
  backend:
    resource: litmus-backend-image

resources:
  litmus-backend-image:
    type: oci-image
    description: OCI image for Litmus Backend server 
    upstream-source: ubuntu/litmuschaos-server:3-24.04_edge


links:
  documentation: https://discourse.charmhub.io/t/18790
  website: https://charmhub.io/litmus-backend-k8s
  source: https://github.com/canonical/litmus-operators/tree/main/backend
  issues: https://github.com/canonical/litmus-operators/issues

requires:
  database:
    optional: false
    interface: mongodb_client
    limit: 1
    description: |
      Require a MongoDB database to store essential information for Litmus Chaos,
      including chaos workflows, experiments, and the results generated from these experiments. 

      Note: This should be the same MongoDB instance used by the Litmus auth server.
  litmus-auth:
    optional: false
    interface: litmus_auth
    limit: 1
    description: |
      Exchange the gRPC server endpoints of the auth and backend components.

provides:
  http-api:
    optional: false
    interface: litmus_backend_http_api
    limit: 1
    description: |
      Send this component's HTTP API to the frontend component.

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git] # handy for git+ dependencies during development
    build-snaps: [astral-uv]
    # FIXME: override-build with "git describe --always > $CRAFT_PART_INSTALL/version" causes
    # charm pack to fail "fatal: not a git repository (or any of the parent directories): .git"

    # override-build: |
    #   craftctl default
    #   git describe --always > $CRAFT_PART_INSTALL/version
