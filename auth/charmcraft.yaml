# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
name: litmus-auth-k8s
type: charm
title: Litmus Authentication Server

assumes:
  - k8s-api
  - juju >= 3.6.0

description: |
  Litmus Authentication Server is a component of the LitmusChaos solution, an open source platform used for chaos testing.
  It is responsible for authenticating and authorising requests received by the ChaosCenter, and for managing users and their associated projects.

summary: |
  Litmus Authentication Server is a component of the LitmusChaos solution, an open source platform used for chaos testing.

containers:
  auth:
    resource: litmus-auth-image
    mounts:
      - storage: certs
        location: /etc/tls

resources:
  litmus-auth-image:
    type: oci-image
    description: OCI image for Litmus authentication server 
    upstream-source: ubuntu/litmuschaos-authserver:3-24.04_edge

storage:
  certs:
    type: filesystem
    minimum-size: 1M

requires:
  database:
    optional: false
    interface: mongodb_client
    limit: 1
    description: |
      Require a MongoDB database to store essential information for 
      Litmus Chaos, including projects, and users.

      Note: This should be the same MongoDB instance used by the Litmus backend server.
  tls-certificates:
    optional: true
    interface: tls-certificates
    limit: 1
    description: |
      Receive TLS certificates.

provides:
  litmus-auth:
    optional: false
    interface: litmus_auth
    limit: 1
    description: |
      Exchange the gRPC server endpoints of the auth and backend components.
  http-api:
    optional: false
    interface: litmus_auth_http_api
    limit: 1
    description: |
      Send this component's HTTP API to the frontend component.

links:
  documentation: https://discourse.charmhub.io/t/18789
  website: https://charmhub.io/litmus-auth-k8s
  source: https://github.com/canonical/litmus-operators/tree/main/auth
  issues: https://github.com/canonical/litmus-operators/issues

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages:
      - git # handy for git+ dependencies during development
      # Required by the tls_certificates_interface
      - cargo
      - libffi-dev
      - libssl-dev
      - pkg-config
      - rustc
    build-snaps: [astral-uv]
    # FIXME: override-build with "git describe --always > $CRAFT_PART_INSTALL/version" causes
    # charm pack to fail "fatal: not a git repository (or any of the parent directories): .git"

    # override-build: |
    #   craftctl default
    #   git describe --always > $CRAFT_PART_INSTALL/version
